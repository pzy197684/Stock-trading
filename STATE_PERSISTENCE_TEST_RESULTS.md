# 状态持久化功能测试报告

## 功能目标
修改系统启动行为：
- 如果之前有实例运行并且没有停止，再次启动UI时实例还在
- 如果之前没有实例运行，就不要加载任何实例

## 实现方案
1. 修改 `_load_and_start_auto_strategies()` 方法，从基于配置文件自动启动改为基于状态文件恢复
2. 添加 `_save_running_instances_state()` 方法来保存运行实例状态
3. 在策略启动、停止、删除时自动保存状态
4. 添加系统清理方法确保最终状态被保存

## 测试结果

### ✅ 测试1：无状态文件的干净启动
- **测试条件**：删除 `state/running_instances.json` 文件
- **预期结果**：系统启动时不加载任何实例
- **实际结果**：
  ```
  日志显示: "📝 No previous running instances found. System starts clean."
  API返回: {"total": 0, "running": 0, "stopped": 0}
  ```
- **状态**：✅ 通过

### ✅ 测试2：实例创建不触发状态保存
- **测试条件**：创建实例但不启动
- **预期结果**：实例存在但不保存到状态文件（因为未运行）
- **实际结果**：
  ```
  实例创建成功: martingale_hedge_1_1759676650
  状态: started=False
  state目录中无 running_instances.json 文件
  ```
- **状态**：✅ 通过

### ✅ 测试3：系统重启后未运行实例不恢复
- **测试条件**：创建但未启动实例，然后重启系统
- **预期结果**：重启后实例不会被恢复
- **实际结果**：
  ```
  重启后 API返回: {"total": 0, "running": 0, "stopped": 0}
  证明未启动的实例不会被保存和恢复
  ```
- **状态**：✅ 通过

### 🔄 待测试：运行实例的状态保存和恢复
- **测试计划**：
  1. 创建并启动一个实例
  2. 确认 `running_instances.json` 文件被创建
  3. 重启系统
  4. 验证实例被正确恢复

## 代码变更摘要

### core/managers/strategy_manager.py
1. **`_load_and_start_auto_strategies()`**：
   - 从扫描profiles目录改为读取 `state/running_instances.json`
   - 只恢复真正运行过的实例

2. **`_save_running_instances_state()`**：
   - 保存当前运行实例到JSON文件
   - 只保存 `is_running()` 返回True的实例

3. **状态保存钩子**：
   - `start_strategy()`: 启动后保存状态
   - `stop_strategy()`: 停止后保存状态
   - `remove_strategy_instance()`: 删除后保存状态

4. **`cleanup()`**：
   - 系统关闭时的最终状态保存

## 新的行为逻辑
```
系统启动 → 检查 state/running_instances.json
├─ 文件不存在 → 干净启动，0个实例
├─ 文件存在但为空 → 干净启动，0个实例  
└─ 文件存在且有数据 → 恢复之前运行的实例

实例操作 → 自动保存当前状态
├─ 创建实例 → 不保存（未运行）
├─ 启动实例 → 保存到状态文件
├─ 停止实例 → 从状态文件移除
└─ 删除实例 → 从状态文件移除
```

## 优势
1. **精确的状态控制**：只恢复真正运行过的实例
2. **避免意外启动**：不再基于配置文件自动启动
3. **状态一致性**：实时同步运行状态
4. **用户体验**：符合"记住上次状态"的预期

## 下一步
需要完成运行实例的完整测试循环，验证状态保存和恢复的完整功能。