<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæ ‡å‡†åŒ–éªŒè¯æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .test-title { 
            color: #333; 
            margin-bottom: 10px; 
            font-weight: bold; 
        }
        .result { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            white-space: pre-wrap; 
            font-family: monospace; 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .success { 
            background-color: #d4edda; 
            border: 1px solid #c3e6cb; 
            color: #155724; 
        }
        .error { 
            background-color: #f8d7da; 
            border: 1px solid #f5c6cb; 
            color: #721c24; 
        }
        .info { 
            background-color: #d1ecf1; 
            border: 1px solid #bee5eb; 
            color: #0c5460; 
        }
        button { 
            background-color: #007bff; 
            color: white; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { 
            background-color: #0056b3; 
        }
        .loading { 
            color: #6c757d; 
            font-style: italic; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª APIæ ‡å‡†åŒ–éªŒè¯æµ‹è¯•å·¥å…·</h1>
        <p>éªŒè¯ä¿®å¤åçš„APIæ¥å£æ˜¯å¦æ­£ç¡®è¿”å›æ ‡å‡†åŒ–æ•°æ®æ ¼å¼</p>

        <div class="test-section">
            <div class="test-title">1. è¿è¡Œå®ä¾‹APIæµ‹è¯•</div>
            <button onclick="testRunningInstances()">æµ‹è¯• /api/running/instances</button>
            <div id="result-instances" class="result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <div class="test-title">2. é…ç½®æ–‡ä»¶APIæµ‹è¯•</div>
            <button onclick="testConfigProfiles()">æµ‹è¯• /api/config/profiles</button>
            <div id="result-config" class="result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <div class="test-title">3. æ—¥å¿—æ–‡ä»¶APIæµ‹è¯•</div>
            <button onclick="testLogFiles()">æµ‹è¯• /api/logs/file</button>
            <div id="result-logs" class="result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <div class="test-title">4. æ•°æ®ç»“æ„éªŒè¯</div>
            <button onclick="validateDataStructures()">éªŒè¯æ•°æ®ç»“æ„ä¸€è‡´æ€§</button>
            <div id="result-validation" class="result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹éªŒè¯...</div>
        </div>

        <div class="test-section">
            <div class="test-title">5. WebSocketè¿æ¥æµ‹è¯•</div>
            <button onclick="testWebSocket()">æµ‹è¯• WebSocket è¿æ¥</button>
            <button onclick="disconnectWebSocket()">æ–­å¼€è¿æ¥</button>
            <div id="result-websocket" class="result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        </div>

        <div class="test-section">
            <div class="test-title">6. ç»¼åˆæµ‹è¯•</div>
            <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <div id="result-all" class="result info">ç‚¹å‡»æŒ‰é’®å¼€å§‹ç»¼åˆæµ‹è¯•...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001';
        let ws = null;

        // æ˜¾ç¤ºç»“æœçš„é€šç”¨å‡½æ•°
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = content;
            element.className = `result ${type}`;
        }

        // æ ¼å¼åŒ–JSONæ˜¾ç¤º
        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }

        // æµ‹è¯•è¿è¡Œå®ä¾‹API
        async function testRunningInstances() {
            showResult('result-instances', 'æ­£åœ¨æµ‹è¯•è¿è¡Œå®ä¾‹API...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/running/instances`);
                const data = await response.json();
                
                // éªŒè¯å“åº”æ ¼å¼
                if (data.success && data.data && data.data.instances) {
                    const instances = data.data.instances;
                    let result = `âœ… æµ‹è¯•æˆåŠŸï¼\n\n`;
                    result += `å“åº”æ ¼å¼éªŒè¯: ${data.success ? 'âœ…' : 'âŒ'}\n`;
                    result += `æ•°æ®ç»“æ„: ${data.data ? 'âœ…' : 'âŒ'}\n`;
                    result += `å®ä¾‹æ•°ç»„: ${Array.isArray(instances) ? 'âœ…' : 'âŒ'}\n`;
                    result += `æ€»å®ä¾‹æ•°: ${data.data.total}\n`;
                    result += `è¿è¡Œä¸­: ${data.data.running}\n`;
                    result += `å·²åœæ­¢: ${data.data.stopped}\n\n`;
                    
                    if (instances.length > 0) {
                        result += `ç¤ºä¾‹å®ä¾‹æ•°æ®:\n`;
                        const example = instances[0];
                        result += `ID: ${example.id}\n`;
                        result += `è´¦æˆ·: ${example.account}\n`;
                        result += `å¹³å°: ${example.platform}\n`;
                        result += `ç­–ç•¥: ${example.strategy}\n`;
                        result += `çŠ¶æ€: ${example.status}\n`;
                        result += `äº¤æ˜“å¯¹: ${example.symbol}\n`;
                        result += `ç›ˆåˆ©: ${example.profit}\n`;
                        result += `ç›ˆåˆ©ç‡: ${example.profit_rate}%\n`;
                    }
                    
                    showResult('result-instances', result, 'success');
                } else {
                    showResult('result-instances', `âŒ å“åº”æ ¼å¼é”™è¯¯:\n${formatJSON(data)}`, 'error');
                }
            } catch (error) {
                showResult('result-instances', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•é…ç½®æ–‡ä»¶API
        async function testConfigProfiles() {
            showResult('result-config', 'æ­£åœ¨æµ‹è¯•é…ç½®æ–‡ä»¶API...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/config/profiles`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    let result = `âœ… é…ç½®æ–‡ä»¶APIæµ‹è¯•æˆåŠŸï¼\n\n`;
                    result += `å“åº”æ ¼å¼: ${data.success ? 'âœ…' : 'âŒ'}\n`;
                    result += `æ€»å¹³å°æ•°: ${data.data.total_platforms}\n`;
                    result += `æ€»è´¦æˆ·æ•°: ${data.data.total_accounts}\n`;
                    result += `é…ç½®æ–‡ä»¶åˆ—è¡¨: ${data.data.profiles ? 'âœ…' : 'âŒ'}\n\n`;
                    
                    showResult('result-config', result, 'success');
                } else {
                    showResult('result-config', `âŒ å“åº”æ ¼å¼é”™è¯¯:\n${formatJSON(data)}`, 'error');
                }
            } catch (error) {
                showResult('result-config', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ—¥å¿—æ–‡ä»¶API
        async function testLogFiles() {
            showResult('result-logs', 'æ­£åœ¨æµ‹è¯•æ—¥å¿—æ–‡ä»¶API...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/logs/file?path=runtime.log`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.logs) {
                    let result = `âœ… æ—¥å¿—æ–‡ä»¶APIæµ‹è¯•æˆåŠŸï¼\n\n`;
                    result += `å“åº”æ ¼å¼: ${data.success ? 'âœ…' : 'âŒ'}\n`;
                    result += `æ—¥å¿—æ•°ç»„: ${Array.isArray(data.data.logs) ? 'âœ…' : 'âŒ'}\n`;
                    result += `æ€»æ—¥å¿—æ¡æ•°: ${data.data.total}\n`;
                    result += `æ–‡ä»¶ä¿¡æ¯: ${data.data.file_info ? 'âœ…' : 'âŒ'}\n\n`;
                    
                    if (data.data.logs.length > 0) {
                        result += `æœ€æ–°æ—¥å¿—ç¤ºä¾‹:\n`;
                        const latestLog = data.data.logs[data.data.logs.length - 1];
                        result += `æ—¶é—´: ${latestLog.timestamp}\n`;
                        result += `çº§åˆ«: ${latestLog.level}\n`;
                        result += `æ¶ˆæ¯: ${latestLog.message.substring(0, 100)}...\n`;
                    }
                    
                    showResult('result-logs', result, 'success');
                } else {
                    showResult('result-logs', `âŒ å“åº”æ ¼å¼é”™è¯¯:\n${formatJSON(data)}`, 'error');
                }
            } catch (error) {
                showResult('result-logs', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // éªŒè¯æ•°æ®ç»“æ„ä¸€è‡´æ€§
        async function validateDataStructures() {
            showResult('result-validation', 'æ­£åœ¨éªŒè¯æ•°æ®ç»“æ„ä¸€è‡´æ€§...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/running/instances`);
                const data = await response.json();
                
                if (!data.success || !data.data || !data.data.instances) {
                    showResult('result-validation', 'âŒ æ— æ³•è·å–å®ä¾‹æ•°æ®è¿›è¡ŒéªŒè¯', 'error');
                    return;
                }
                
                let result = `ğŸ” æ•°æ®ç»“æ„ä¸€è‡´æ€§éªŒè¯:\n\n`;
                let allValid = true;
                
                // æ£€æŸ¥æ¯ä¸ªå®ä¾‹çš„æ•°æ®ç»“æ„
                data.data.instances.forEach((instance, index) => {
                    result += `å®ä¾‹ ${index + 1} (${instance.id}):\n`;
                    
                    // å¿…éœ€å­—æ®µæ£€æŸ¥
                    const requiredFields = ['id', 'account', 'platform', 'strategy', 'status', 'symbol'];
                    requiredFields.forEach(field => {
                        const hasField = instance.hasOwnProperty(field) && instance[field] !== null;
                        result += `  ${field}: ${hasField ? 'âœ…' : 'âŒ'}\n`;
                        if (!hasField) allValid = false;
                    });
                    
                    // çŠ¶æ€å€¼æ£€æŸ¥
                    const validStatuses = ['running', 'stopped', 'error', 'starting'];
                    const statusValid = validStatuses.includes(instance.status);
                    result += `  çŠ¶æ€å€¼æœ‰æ•ˆ: ${statusValid ? 'âœ…' : 'âŒ'} (${instance.status})\n`;
                    if (!statusValid) allValid = false;
                    
                    // æ•°å€¼å­—æ®µæ£€æŸ¥
                    const numericFields = ['profit', 'profit_rate'];
                    numericFields.forEach(field => {
                        const isNumeric = typeof instance[field] === 'number';
                        result += `  ${field}æ•°å€¼: ${isNumeric ? 'âœ…' : 'âŒ'}\n`;
                        if (!isNumeric && instance[field] !== null) allValid = false;
                    });
                    
                    result += '\n';
                });
                
                result += `\nğŸ“Š æ€»ä½“éªŒè¯ç»“æœ: ${allValid ? 'âœ… æ‰€æœ‰æ•°æ®ç»“æ„ç¬¦åˆæ ‡å‡†' : 'âŒ å­˜åœ¨æ•°æ®ç»“æ„é—®é¢˜'}`;
                
                showResult('result-validation', result, allValid ? 'success' : 'error');
                
            } catch (error) {
                showResult('result-validation', `âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•WebSocketè¿æ¥
        function testWebSocket() {
            if (ws) {
                ws.close();
            }
            
            showResult('result-websocket', 'æ­£åœ¨è¿æ¥WebSocket...', 'loading');
            
            try {
                ws = new WebSocket('ws://localhost:8001/ws/logs');
                let messages = [];
                
                ws.onopen = () => {
                    showResult('result-websocket', 'âœ… WebSocketè¿æ¥æˆåŠŸï¼\nç­‰å¾…æ—¥å¿—æ¶ˆæ¯...', 'success');
                };
                
                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        messages.push(message);
                        
                        let result = `âœ… WebSocketè¿æ¥æ­£å¸¸ï¼\n\n`;
                        result += `å·²æ¥æ”¶æ¶ˆæ¯æ•°: ${messages.length}\n\n`;
                        result += `æœ€æ–°æ¶ˆæ¯:\n`;
                        result += `ç±»å‹: ${message.type}\n`;
                        result += `æ—¶é—´: ${new Date().toLocaleTimeString()}\n`;
                        
                        if (message.data) {
                            result += `æ•°æ®: ${JSON.stringify(message.data, null, 2)}`;
                        }
                        
                        showResult('result-websocket', result, 'success');
                        
                    } catch (e) {
                        showResult('result-websocket', `âŒ æ¶ˆæ¯è§£æé”™è¯¯: ${e.message}`, 'error');
                    }
                };
                
                ws.onerror = (error) => {
                    showResult('result-websocket', `âŒ WebSocketé”™è¯¯: ${error}`, 'error');
                };
                
                ws.onclose = () => {
                    showResult('result-websocket', 'ğŸ”Œ WebSocketè¿æ¥å·²å…³é—­', 'info');
                };
                
            } catch (error) {
                showResult('result-websocket', `âŒ WebSocketè¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ–­å¼€WebSocketè¿æ¥
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
                showResult('result-websocket', 'ğŸ”Œ WebSocketè¿æ¥å·²æ‰‹åŠ¨æ–­å¼€', 'info');
            } else {
                showResult('result-websocket', 'âŒ æ²¡æœ‰æ´»åŠ¨çš„WebSocketè¿æ¥', 'error');
            }
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            showResult('result-all', 'ğŸš€ å¼€å§‹è¿è¡Œç»¼åˆæµ‹è¯•...', 'loading');
            
            let allResults = '';
            
            // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•
            const tests = [
                { name: 'è¿è¡Œå®ä¾‹API', func: testRunningInstances },
                { name: 'é…ç½®æ–‡ä»¶API', func: testConfigProfiles },
                { name: 'æ—¥å¿—æ–‡ä»¶API', func: testLogFiles },
                { name: 'æ•°æ®ç»“æ„éªŒè¯', func: validateDataStructures }
            ];
            
            for (let test of tests) {
                allResults += `\n=== ${test.name} ===\n`;
                try {
                    await test.func();
                    allResults += 'âœ… æµ‹è¯•å®Œæˆ\n';
                } catch (error) {
                    allResults += `âŒ æµ‹è¯•å¤±è´¥: ${error.message}\n`;
                }
                
                // çŸ­æš‚å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            allResults += '\nğŸ¯ ç»¼åˆæµ‹è¯•å®Œæˆï¼';
            allResults += '\nè¯·æŸ¥çœ‹å„ä¸ªæ¨¡å—çš„è¯¦ç»†æµ‹è¯•ç»“æœã€‚';
            
            showResult('result-all', allResults, 'success');
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸ§ª APIæ ‡å‡†åŒ–éªŒè¯æµ‹è¯•å·¥å…·å·²åŠ è½½');
            console.log('APIåŸºç¡€åœ°å€:', API_BASE);
        };
    </script>
</body>
</html>