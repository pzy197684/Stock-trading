# Stock-tradingæ¡†æ¶ä¸­çš„çŠ¶æ€ç®¡ç†å™¨æ€»è§ˆ

## ğŸ“‹ å·²å‘ç°çš„çŠ¶æ€ç®¡ç†å™¨

### 1. ğŸ—ï¸ æ¡†æ¶çº§é€šç”¨çŠ¶æ€ç®¡ç†å™¨

**æ–‡ä»¶**: `core/managers/state_manager.py`  
**ç±»å**: `StateManager`  
**èŒè´£**: æ¡†æ¶çº§åˆ«çš„è´¦æˆ·çŠ¶æ€ç®¡ç†
- ç®¡ç† `AccountState` å’Œ `PositionState`
- æä¾›æ‰¹é‡çŠ¶æ€æ›´æ–°åŠŸèƒ½
- æ”¯æŒæ‰€æœ‰ç­–ç•¥çš„åŸºç¡€çŠ¶æ€æ“ä½œ

### 2. ğŸ¯ Recoveryç­–ç•¥ä¸“ç”¨çŠ¶æ€æŒä¹…åŒ–ç®¡ç†å™¨

**æ–‡ä»¶**: `core/strategy/recovery/recovery_state_persister.py`  
**ç±»å**: `RecoveryStatePersister`  
**èŒè´£**: Recoveryç­–ç•¥çš„å¤æ‚çŠ¶æ€æŒä¹…åŒ–
- ç®¡ç†Recoveryç­–ç•¥çš„å¤šå±‚çŠ¶æ€ç»“æ„
- æä¾›é…ç½®å˜æ›´æ£€æµ‹å’ŒçŠ¶æ€è¿ç§»
- æ”¯æŒçŠ¶æ€å¤‡ä»½å’Œæ¢å¤åŠŸèƒ½

### 3. ğŸ”„ é©¬ä¸å¯¹å†²ç­–ç•¥çŠ¶æ€ç®¡ç†å™¨

**æ–‡ä»¶**: `core/strategy/martingale_hedge/utils.py`  
**ç±»å**: `MartingaleStateManager`  
**èŒè´£**: é©¬ä¸å¯¹å†²ç­–ç•¥çš„çŠ¶æ€ç®¡ç†

#### ğŸ” è¯¦ç»†åŠŸèƒ½åˆ†æ

**æ ¸å¿ƒæ–¹æ³•**:
- `create_default_state()` - åˆ›å»ºé»˜è®¤çŠ¶æ€ç»“æ„
- `validate_state()` - éªŒè¯çŠ¶æ€å®Œæ•´æ€§
- `migrate_legacy_state()` - ä»928é¡¹ç›®è¿ç§»çŠ¶æ€

**çŠ¶æ€ç»“æ„**:
```python
{
    "long": {
        "qty": 0.0,
        "avg_price": 0.0,
        "add_times": 0,
        "last_qty": 0.0,
        "last_entry_price": 0.0,
        "last_fill_price": 0.0,
        "add_history": [],
        "round": 1,
        "opposite_qty": 0.0,
        "fast_add_paused_until": 0,
        "hedge_state": {
            "hedge_locked": False,
            "hedge_stop": False,
            "locked_profit": 0.0,
            "hedge_locked_on_full": False,
            "cooldown_until": 0
        }
    },
    "short": { /* åŒlongç»“æ„ */ },
    "global": {
        "exchange_fault_until": 0,
        "backfill_done": {"long": False, "short": False},
        "schema_version": "1.0.0",
        "last_update": int(time.time())
    }
}
```

**ç‰¹æ®ŠåŠŸèƒ½**:
1. **çŠ¶æ€éªŒè¯**: å®Œæ•´çš„çŠ¶æ€ç»“æ„éªŒè¯ï¼Œæ£€æŸ¥å¿…éœ€å­—æ®µå’Œæ•°å€¼æœ‰æ•ˆæ€§
2. **çŠ¶æ€è¿ç§»**: æ”¯æŒä»928é¡¹ç›®çš„çŠ¶æ€æ ¼å¼è¿ç§»åˆ°Stock-tradingæ ¼å¼
3. **é”ä»“çŠ¶æ€**: ä¸“é—¨çš„hedge_stateç®¡ç†é”ä»“çŠ¶æ€
4. **å†å²è®°å½•**: add_historyå­—æ®µè®°å½•åŠ ä»“å†å²

## ğŸ“Š çŠ¶æ€ç®¡ç†å™¨å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | æ¡†æ¶StateManager | Recovery StatePersister | Martingale StateManager |
|------|------------------|-------------------------|--------------------------|
| **æ–‡ä»¶ä½ç½®** | core/managers/ | core/strategy/recovery/ | core/strategy/martingale_hedge/ |
| **ç®¡ç†èŒƒå›´** | å…¨å±€è´¦æˆ·çŠ¶æ€ | Recoveryç­–ç•¥çŠ¶æ€ | é©¬ä¸å¯¹å†²ç­–ç•¥çŠ¶æ€ |
| **å¤æ‚åº¦** | ç®€å•æ ‡å‡†ç»“æ„ | å¤æ‚å¤šå±‚çŠ¶æ€ | å¤æ‚å¯¹å†²çŠ¶æ€ |
| **æŒä¹…åŒ–** | ç›´æ¥è°ƒç”¨state_store | StateStoreå®ä¾‹ç®¡ç† | TODOæœªå®ç° |
| **çŠ¶æ€éªŒè¯** | åŸºç¡€éªŒè¯ | é…ç½®å…¼å®¹æ€§æ£€æŸ¥ | å®Œæ•´ç»“æ„éªŒè¯ |
| **çŠ¶æ€è¿ç§»** | ä¸æ”¯æŒ | ä¸æ”¯æŒ | æ”¯æŒ928é¡¹ç›®è¿ç§» |
| **å¤‡ä»½æ¢å¤** | ä¸æ”¯æŒ | æ”¯æŒ | ä¸æ”¯æŒ |
| **é”ä»“ç®¡ç†** | åŸºç¡€æ”¯æŒ | ä¸æ¶‰åŠ | ä¸“é—¨çš„hedge_state |

## ğŸ”§ å‘ç°çš„é—®é¢˜

### 1. **é©¬ä¸å¯¹å†²ç­–ç•¥çŠ¶æ€æŒä¹…åŒ–æœªå®ç°**
åœ¨ `core/strategy/martingale_hedge/strategy.py` ä¸­å‘ç°ï¼š
```python
def _save_state_to_storage(self):
    """ä¿å­˜çŠ¶æ€åˆ°å­˜å‚¨ - å®é™…åº”ç”¨æ—¶éœ€è¦å®ç°æŒä¹…åŒ–å­˜å‚¨"""
    # TODO: å®ç°çŠ¶æ€æŒä¹…åŒ–å­˜å‚¨
    pass
```

### 2. **å‘½åä¸ä¸€è‡´**
- Recoveryç­–ç•¥: `RecoveryStatePersister` (å·²é‡å‘½åï¼ŒèŒè´£æ˜ç¡®)
- é©¬ä¸å¯¹å†²ç­–ç•¥: `MartingaleStateManager` (ä»ä½¿ç”¨StateManagerå‘½å)

## ğŸ’¡ å»ºè®®æ”¹è¿›

### 1. **ç»Ÿä¸€å‘½åè§„èŒƒ**
å»ºè®®å°† `MartingaleStateManager` é‡å‘½åä¸º `MartingaleStatePersister` ä»¥ä¿æŒä¸€è‡´æ€§ã€‚

### 2. **å®ç°é©¬ä¸å¯¹å†²çŠ¶æ€æŒä¹…åŒ–**
é©¬ä¸å¯¹å†²ç­–ç•¥å·²æœ‰å®Œæ•´çš„çŠ¶æ€ç®¡ç†åŠŸèƒ½ï¼Œä½†ç¼ºä¹æŒä¹…åŒ–å®ç°ã€‚å»ºè®®ï¼š
- å®ç° `_save_state_to_storage()` æ–¹æ³•
- æ·»åŠ çŠ¶æ€åŠ è½½å’Œæ¢å¤åŠŸèƒ½
- å‚è€ƒRecoveryçš„æŒä¹…åŒ–æ¨¡å¼

### 3. **åˆ›å»ºä¸“ç”¨æ–‡ä»¶**
è€ƒè™‘å°† `MartingaleStateManager` ä» `utils.py` ç§»åŠ¨åˆ°ä¸“ç”¨çš„ `martingale_state_persister.py` æ–‡ä»¶ã€‚

## ğŸ¯ ç»“è®º

Stock-tradingæ¡†æ¶ä¸­ç›®å‰æœ‰3ä¸ªçŠ¶æ€ç®¡ç†å™¨ï¼š

1. **æ¡†æ¶çº§**: `StateManager` - åŸºç¡€è´¦æˆ·çŠ¶æ€ç®¡ç†
2. **Recoveryç­–ç•¥**: `RecoveryStatePersister` - å®Œæ•´çš„çŠ¶æ€æŒä¹…åŒ–æ–¹æ¡ˆ
3. **é©¬ä¸å¯¹å†²ç­–ç•¥**: `MartingaleStateManager` - åŠŸèƒ½å®Œæ•´ä½†æŒä¹…åŒ–æœªå®ç°

é©¬ä¸å¯¹å†²ç­–ç•¥çš„çŠ¶æ€ç®¡ç†å™¨åŠŸèƒ½æœ€ä¸ºå®Œå–„ï¼ŒåŒ…å«çŠ¶æ€éªŒè¯ã€è¿ç§»ç­‰é«˜çº§åŠŸèƒ½ï¼Œæ˜¯ç›®å‰æœ€æˆç†Ÿçš„ç­–ç•¥çº§çŠ¶æ€ç®¡ç†å™¨å®ç°ã€‚